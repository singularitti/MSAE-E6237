% !TEX root = report.tex

\section{Molecular dynamics code}

The following part is an introduction on how to use
Wentzcovitch's code to perform MD simulation. The code is
based on one of her papers.\cite{Wentzcovitch:1991ka}

There are $4$ types of simulations in code,
denoted as \texttt{md}, \texttt{cd}, \texttt{nd}, \texttt{sd},
respectively. The first one means ``molecular dynamics'',
based on Andersen's paper,\cite{Andersen:1980ew},
the second one means ``cell dynamics'', based on
Rahmanâ€“Parrinello approach,\cite{Parrinello:1980kx},
the main equations are $\eqref{eq:rpeqm}$.
The third case is called ``new cell dynamics'' and is based on
$\eqref{eq:rpsdd}$ and $\eqref{eq:wenzhdd2}$,
the last one is called ``strain dynamics'' and is based on
$\eqref{eq:rpsdd}$ and $\eqref{eq:wenzhdd}$.

The simulation is done under zero temperature, as stated above.

\texttt{mxdtyp} denotes the array dimension for type of atoms,
in the input file there will be a line labeled by \texttt{(ntype)}, it
contains a scalar, i.e., number of atom types, so \texttt{mxdtyp} $=1$.

\subsection{Main program}

Read \texttt{nstep} from input file, determine how many steps are
to be performed in the following MD loop.

Then we start a MD loop.
First update the current step \texttt{nzero}, and then update those
accumulators \texttt{acu}, \texttt{ack} and \texttt{acp}, then calculate
their averages by dividing \texttt{nzero}. Then call \texttt{move} subroutine,
\texttt{p} is updated during this step, however \texttt{vcell} is not.
Then calculate $p \Omega$ and do a corresponding accumulator \texttt{acpv} and
average \texttt{avpv}. And then, update arrays like \texttt{utm} with length
\texttt{nstep} (read from input). 
Then calculate the new temperature, \texttt{tnew}, by assuming equipartition 
theorem $\mean{E} = \frac{ 3 }{ 2 } k_B T$, where $\mean{E}$ is
the average kinetic energy \texttt{avk}.
Then do rescaling on Cartesian velocity \texttt{v} and reduced velocity
\texttt{ratd}.

% Table generated by Excel2LaTeX from sheet 'Sheet1'
\begin{table}[h]
	\centering
	\caption{List of some output variables of main program.}
	\begin{tabular}{@{}rlccc@{}}
		\toprule
		\multicolumn{2}{c}{variable name} & variable symbol & variable & write to file \\
		\midrule
		\multirow{4}[2]{*}{total}                                                         & potential energy     & $U_t$           & \texttt{utm}    & \multirow{4}[2]{*}{\texttt{e}}   \\
		                                                                                  & total kinetic energy & $E_t$           & \texttt{ekintm} &                                  \\
		                                                                                  & energy               & $\mathscr{E}_t$ & \texttt{etotm}  &                                  \\
		                                                                                  & $p \Omega$           & $p \Omega$      & \texttt{pvm}    &                                  \\
		\cmidrule{1-1}\cmidrule{4-5}    \multirow{3}[2]{*}{atomic contribution to total}  & potential energy     &                 & \texttt{utam}   & \multirow{6}[4]{*}{\texttt{eal}} \\
		                                                                                  & kinetic energy       &                 & \texttt{ekam}   &                                  \\
		                                                                                  & energy               &                 & \texttt{etam}   &                                  \\
		\cmidrule{1-1}\cmidrule{4-4}    \multirow{3}[2]{*}{lattice contribution to total} & potential energy     &                 & \texttt{utlm}   &                                  \\
		                                                                                  & kinetic energy       &                 & \texttt{eklm}   &                                  \\
		                                                                                  & energy               &                 & \texttt{etlm}   &                                  \\
		\cmidrule{1-1}\cmidrule{4-5}    \multirow{2}[2]{*}{average of accumulated}        & potential energy     & $\mean{U}_t$    & \texttt{avum}   & \multirow{2}[2]{*}{\texttt{ave}} \\
		                                                                                  & kinetic energy       & $\mean{E}_t$    & \texttt{avkm}   &                                  \\
		\bottomrule
	\end{tabular}
	\label{tab:lstvar}%
\end{table}%

At the end of MD loop, write outputs to files.
Some of the output variables are listed in Tab. \ref{tab:lstvar}.
The atomic and lattice contributions could be also understood as
ionic and cell contributions, respectively. Another
important output file is \texttt{avec}, which stores lengths and angles 
between primitive cell vectors for each MD step, i.e.,
$\{a, b, c\}$ and $\{\alpha, \beta, \gamma\}$,
denoted by \texttt{bmodm} and
\texttt{thetam}, respectively. 
\texttt{bmodm} at each MD step
is set to lattice vectors moduli \texttt{avmod}, computed by \texttt{MOVE} subroutine.
\texttt{tv} file stores the ``instantaneous'' temperature and volume
for each MD step.

\subsection{Setup steps}

\subsubsection{\texttt{CRSTL} subroutine}

This subroutine does some pre-setting work before \texttt{INIT}.

First read the $3 \times 3$ matrix \texttt{avec} from \texttt{inp} file,
if \texttt{ic} flag is \texttt{'s'}.
Since it is in reduced coordinates, we need to rewrite it in Cartesian
coordinates. First store the sign of each entry, the do some transformation according to
the corresponding \texttt{iop} matrix entry(\textcolor{red}{What is this?}). The 
rules are
\begin{equation}\label{eq:crstltrans}
	h(i, j) = \sign \big( h(i, j) \big) \times a_0 \times n(j)
	\begin{cases}
		\sqrt{h(i, j)},                 & \text{\texttt{iop(i,j)} is \texttt{'s'};} \\
		h(i, j)^{1/3},                  & \text{\texttt{iop(i,j)} is \texttt{'c'};} \\
		\frac{ 1 }{ 3 } h(i, j),        & \text{\texttt{iop(i,j)} is \texttt{'c'};} \\
		\frac{ 1 }{ \sqrt{3} } h(i, j), & \text{\texttt{iop(i,j)} is \texttt{'t'},} 
	\end{cases}
\end{equation}
where $n(j)$ denotes the number of primitive cells along $j$th direction.
Then read \texttt{avec}, \texttt{avecd}, \texttt{avec2di} as 
input for subsequent runs, and write them to standard output.

\begin{table}[h]
	\centering
	\caption{List of some variables in \texttt{CRSTL} subroutine.}
	\begin{tabular}{@{}lcr@{}}
		\toprule
		{variable name}                        & variable symbol                                 & variable       \\
		\midrule
		lattice vectors matrix                 & $h = \{ \bm{a}, \bm{b}, \bm{c} \}$              & \texttt{avec}  \\
		atomic position in reduced coordinates &                                                 & \texttt{rat}   \\
		atomic velocity in reduced coordinates &                                                 & \texttt{ratd}  \\
		number of primitive cells              & $n$                                             & \texttt{nsc}   \\
		lattice parameter                      & $a_0$                                           & \texttt{alatt} \\
		fictitious mass                        & $W$                                             & \texttt{cmass} \\
		external pressure                      & $P$                                             & \texttt{press} \\
		reciprocal lattice vectors matrix      & $\sigma$                                        & \texttt{sigma} \\
		metric tensor                          & $g = h \tran h$                                 & \texttt{g}     \\
		metric tensor velocity                 & $\dot{g} = \dot{ h }\tran h + h \dot{ h }\tran$ & \texttt{gd}    \\
		metric tensor inverse                  & $g^{-1}$                                        & \texttt{gm1}   \\
		\bottomrule
	\end{tabular}%
	\label{tab:crstl}%
\end{table}%

Then calculate cell volume $\Omega$, metric tensor $g$ and $g^{-1}$.

Then read positions \texttt{rat} for each atom of each type.
If \texttt{ic} flag is \texttt{'s'},
then do similar transformation of these positions as $\eqref{eq:crstltrans}$ does;
if it is \texttt{'c'}, i.e., it is an intermediate step, then read 
\texttt{avec}, \texttt{avecd}, \texttt{avec2di} from last run.


\subsubsection{\texttt{INIT} subroutine}

First, call \texttt{RANV} subroutine, and initialize \texttt{avecd},
\texttt{avec2d} and \texttt{gd}, etc.
\texttt{ilj} is the only variable set by hand in code, if it is equal to $1$,
the code will call \texttt{FORCLJ} subroutine, else it will call \texttt{FORC}
subroutine, see \ref{sssec:forc} and \ref{sssec:forclj} for differences.

Then if \texttt{calc} flag is not set to \texttt{md} and \texttt{mm}
then \texttt{gmgd} is calculated.

If \texttt{calc} flag is set to \texttt{nd} or \texttt{nm}
then \texttt{SIGP} is called, if it is set to \texttt{sd} or
\texttt{sm} then \texttt{SIGS} is called, see \ref{sssec:sigs&p}
for more detail.
With
$\sigma_0 = 
\{
\bm{a}_0 \times \bm{b}_0, \bm{b}_0 \times \bm{c}_0,
\bm{c}_0 \times \bm{a}_0 
\}
= \frac{ V_0 }{ 2\pi } \{
\bm{c}^\ast_0, \bm{a}^\ast_0, \bm{b}^\ast_0
\}$,
we know
$\ddot{d} = \frac{ 1 }{ V_0 }\ddot{h} \sigma_0$.
Then we do strain symmetrization, $\ddot{d}_{ij} = \frac{ 1 }{ 2 }
(\ddot{d}_{ij} + \ddot{d}_{ji})$.
Then $\ddot{h} = \ddot{d} h_0$.

If in \texttt{nd} or \texttt{nm}, we do 
$\Tr (\dot{h}\tran \sigma \sigma \dot{h})$.

If in \texttt{sd} or \texttt{sm}, we do 
$\Tr(\dot{h}\tran \sigma_0 \sigma_0\tran \dot{ h })$.

Then in both cases, we do
\texttt{ekl} $=$ \texttt{ekl} + $\Tr (\dot{ h }\tran \dot{ h })$.

Total kinetic energy is $E_{t} = $ \texttt{eka} + $\frac{ 1 }{ 2 } W ekl$,
where $W$ is the fictitious mass,
total potential energy $U_{t} = ???E_{t} + P \Omega$, where $P$ is the external pressure.
Total energy is $\mathscr{E}_{t} = E_t + U_{t}$.


\subsubsection{\texttt{RDPP} subroutine}

This subroutine reads the pair-potential file.
Here \texttt{ntype} is the number of different types of atoms.
It reads the potential of $i$th atom and $j$th atom, where $j \geq i$.
So in the code we need to do some assignments like
\begin{align}
	U_{ij}      & = U_{ji},      \\
	\bm{F}_{ij} & = \bm{F}_{ji}, 
\end{align}
where $U_{ji}$ and $\bm{F}_{ji}$ are what we read from file,
thus we can save time on IO operations.


\subsubsection{\texttt{RANV} subroutine}

This subroutine is dedicated for setting up Maxwell distributed random velocities
at temperature $T$.


